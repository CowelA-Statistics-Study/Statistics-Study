# Chapter 3

# 통계적 실험과 유의성 검정

- 실험설계는 사실상 모든 응용 연구 분야에서 통계분석의 토대가 된다.
- 전형적인 통계 추론 과정
    1. 가설을 세운다
    2. 실험을 설계한다
    3. 데이터를 수집한다
    4. 추론 및 결론을 도출한다.

## 3.1 A/B 검정

- A/B 검정은 두가지 처리 방법, 제품, 절차 중 어느 쪽이 다른 쪽보다 우월하다는 것을 입증하기 위해 실험군을 두 그룹으로 나누어 진행하는 실험이다.
    - 그 중 하나는 기준이 되는 기존 방법이거나 아예 아무런 처리도 적용하지 않는 방법이 된다.
        - 이를 **대조군** 이라고 한다.
- A/B 검정은 그 결과를 쉽게 측정할 수 있으므로 웹 디자인이나 마케팅에서 일반적으로 사용된다.

### 3.1.1 대조군은 왜 필요할까

- 대조군이 없다면 모든 다른것들은 동일하다는 보장이 없으며, 어떤 차이가 처리 때문인지 확신할 수 없다.

### 3.1.2 왜 하필 A/B일까 C,D가 아니라?

- A/B 검정은 마케팅 및 전자 상거래 분야에서 널리 사용되지만 그렇다고 이것이 유일한 통계실험 유형인 것은 아니다.
- 전통적인 의미의 통계적 실험설계는 특정 처리 방법의 효과에 대한 정적인 질문에 답하는 데 초점을 맞추었다.

## 3.2 가설검정

- 관찰된 효과가 우연에 의한 것인지 여부를 알아내는 것
- 통계적 가설검정은 연구자가 랜덤하게 우연히 일어난 일에 속지 않도록 보호하기 위한 방법으로 개발되었다.
- 통계 가설검정은 그룹 A와 그룹 B사이에서 보이는 차이가 우연에 의한 것인지를 평가하기 위해 A/B검정이나 더 나아가 그 외 여러 무작위 실험을 포함하는 분석을 의미한다.

### 3.2.1 귀무가설

- 그룹들이 보이는 결과를 서로 동일하며, 그룹 간의 차이는 우연에 의한 결과라는 것을 기본 가정으로 설정한다.
- 귀무가설이 틀렸다는 것을 입증해서, ,A그룹과 B그룹의 차이가 우연이 아니라는 것을 보여주는 것이 모두의 희망이다.
- 이를 위한 방법으로는 재표본추출 순열검정을 통한 방법이 있다.
    - A,B 그룹의 결과를 서로 섞어서 비슷한 크기의 그룹들을 반복적으로 나눈 다음, 관찰된 차이를 각 경우에서 발생되는 차이와 비교했을 때 얼마나 극단적인지 관찰하는 방법이다.

### 3.2.2 대립가설

- 가설검정은 그 성격상 귀무가설 뿐 아니라 그와 대립하는 가설을 포함한다.

---

귀무가설 : 그룹 A와 그룹 B의 평균에는 차이가 없다.

대립가설 : A는 B와 다르다.

귀무가설 : A ≤ B

대립가설 : A > B

귀무가설 : B는 A보다 X% 더 크지 않다.

대립가설 : B는 A보다 X% 더 크다.

---

### 3.2.3 일원/이원 가설검정

- 일원 가설검정
    - 방향성을 고려한 대립가설
    - 우연에 의한 극단적인 결과에 대해 한 방향만을 고려하여 P값을 계산한다.
- 이원 가설검정
    - 우연에 의한 극단적인 결과가 양쪽에서 나타날 P값을 계산한다.

## 3.3 재표본추출

- 랜덤한 변동성을 알아보기 위하여 관찰된 데이터 값에서 표본을 반복적으로 추출하는 것
- 재표본추출의 종류
    - 부트스트랩
        - 추정의 신뢰성을 평가하는데 사용
    - 순열검정
        - 일반적으로 두 개 이상의 그룹과 관련된 가설을 검증하는데 사용된다.

### 3.3.1 순열검정

- 순열과정에는 두개 이상의 표본이 관여되며 이들은 통상적으로 A/B 또는 기타 가설검정을 위해 사용되는 그룹들이다.

순열 절차

---

1. 여러 그룹의 결과를 단일 데이터 집합으로 결합한다.
2. 결합된 데이터를 잘 섞은 후, 그룹 A와 동일한 크기의 표본을 무작위로 추출한다.
3. 나머지 데이터에서 그룹 B와 동일한 크기의 샘플을 무작위로 추출한다.
4. 다른 그룹에 대해서도 동일한 작업을 수행한다.
5. 지금 추출한 재표본에 대해 모두 다시 계산하고 기록한다. 이 것으로 한번의 순열 반복이 진행된다.
6. 앞선 단계들을 R번 반복하여 검정통계량의 순열분포를 얻는다.

---

- 관찰된 차이가 대부분의 순열분포 바깥에 있다면, 이는 우연이 아니라고 여길 수 있고, 이러한 결과는 통계적으로 유의미하다.

### 3.3.2 예제: 웹 점착성

- 두가지 웹 디자인을 놓고 어느 쪽이 더 나은 판매 효과를 가져올지 검증하는 과정
    - 잠재적 대리변수
        - 상세 페이지 클릭 수
        - 페이지에서 머문 시간
        
        <img src='../gunwo/Chapter 3/Untitled.png'>

        
        - B페이지가 조금 더 효과적이다.
        
        <img src='../gunwo/Chapter 3/Untitled 1.png'>

        
        - 페이지 A와 페이지 B 사이의 세션 시간 차이에 대한 도수분포
        - 여기서 수직선은 관측된 차이를 보여준다.
        
        ### 3.3.3 전체 및 부트스트랩 순열검정
        
        - 앞서 살펴본 랜덤 셔플링 절차를 임의순열검정, 임의화검정이라고 부르며, 전체순열검정과 부트스트랩 순열검정이라는 변종이 더 있다.
        - 전체순열검정
            - 데이터를 무작위로 섞고 나누는 대신 실제로 나눌 수 있는 모든 가능한 조합을 찾는다.
        - 부트스트랩 순열검정
        - 무작위 순열검정의 2,3단계에서 비복원 추출을 복원추출로 수행한다.
        
        ### 3.3.4 순열검정: 데이터 과학의 최종 결론
        
        - 순열검정은 랜덤한 변이가 어떤 역할을 하는지 알아보기 위해 사용되는 휴리스틱한 절차이다.

## 3.4 통계적 유의성과 P값

- 통계적 유의성이란 통계학자가 자신의 실험결과가 우연히 일어난 것인지 우연히 일어날 수 없는 극단적인 것인지 판단하는 방법이다.

### 3.4.1 P값

- P값은 귀무가설을 구체화한 기회 모델이 주어졌을 때 관측된 결과와 같이 특이하거나 극단적인 결과를 얻을 확률이다.
- 그래프를 눈으로 보는 것 보다는, P값과 같이 통계적 유의성을 정확히 측정하기 위한 지표가 필요하다.
- 순열검정으로 얻은 결과 중에서, 관찰된 차이와 같거나 더 큰 차이를 보이는 경우의 비율로 P값을 추정할 수 있다.

### 3.4.2 유의수준

- 유의수준은 귀무가설을 기각하기 위한 임계값을 의미한다.
- 보통 0.05(5%)나 0.01(1%)이 사용되며, 이 값보다 작으면 귀무가설을 기각하고 대립가설을 채택한다.
- 통계적으로 유의하다는 결론을 내리는 기준이 된다.

### 3.4.3 제1종과 제2종 오류

- 통계적 유의성을 평가할 때는 두가지 유형의 오류가 발생할 수 있다.
    - 1종 오류: 어떤 효과가 우연히 발생한 것인데, 그것이 사실이라고 잘못 판단하는 경우
    - 2종 오류: 어떤 효과가 실제로 있는 것인데, 그것이 우연히 발생한 것이라고 잘못 판단하는 경우

## 3.5 t 검정

- 정규분포를 따르는 모집단에 대한 가설검정에 활용된다.
- 대표적으로 두 집단의 평균 차이에 대한 가설 검정에 활용된다.
- 검정통계량 t를 사용하여 가설검정을 수행한다.
- t 검정의 종류
    - 일표본 t 검정
        - 모집단의 평균이 주어졌을 때, 표본 평균이 모집단 평균과 유의미하게 차이나는지 검정하는 방법
    - 독립표본 t 검정
        - 두 개의 독립된 모집단에서 추출된 두 개의 표본에 대해, 두 모집단의 평균차이가 유의미한지 검정하는 방법
    - 대응표본 t 검정
        - 두 개의 관측치가 서로 관련이 있을 때, 즉 동일한 개체를 대조군과 처리군의 두 조건 중 하나에 할당한 경우에 대해 두 대응표본의 평균 차이가 유의미한지 검정하는 방법

## 3.6 다중검정

- 다중검정은 여러 개의 가설검정을 동시에 수행하여, 적어도 하나의 가설에서 유의미한 결과를 얻을 확률을 계산하는 방법이다.
- 유의수준을 일정 수준으로 유지하면서 여러 개의 가설검정을 수행하면, 유의수준이 증가하게 되어 잘못된 결론을 내릴 가능성이 증가한다.
- 다중검정 방법
    - Bonferroni 방법
        - 가장 보수적인 방법으로, 개별적인 유의수준을 모든 가설의 수로 나누어 적용하는 방법이다.
    - False Discovery Rate(FDR) 방법
        - 유의미한 결과를 내기 위해 제시한 가설 중에서 거짓 양성 비율을 허용하는 방법이다.
        - FDR이 낮을수록 검정력이 높다고 볼 수 있다.

## 3.7 자유도

- 자유도
    - 표본 데이터에서 계산된 통계량에 적용되며 변화가 가능한 값들의 개수
    - 자유도는 많은 통계 검정에서 입력으로 주어지는 값이다.

## 3.8 분산분석

## 3.8 분산분석

- 분산분석(ANOVA: Analysis of Variance)은 여러 그룹 간의 평균 차이가 통계적으로 유의미한지를 검증하는 방법이다.
- 각 그룹 내의 변동과 그룹 간의 변동을 비교하여 평균 차이의 크기를 계산한다.
- 일원분산분석과 이원분산분석으로 나뉘며, 각각 독립변수가 1개와 2개인 경우에 사용된다.
- 분산분석 절차
    1. 귀무가설과 대립가설 설정
    2. 유의수준 설정
    3. 가설검정을 위한 검정통계량 계산
    4. 귀무가설의 기각 여부 결정
- 분산분석 예제
    - 서로 다른 브랜드의 광고에 노출된 고객들의 구매금액을 비교한다.
    - 광고 브랜드별로 그룹을 나누어 각 그룹의 구매금액 평균을 비교한다.
    - 광고 브랜드별로 그룹을 나누지 않고 모든 데이터를 하나의 그룹으로 묶고, 브랜드별로 구매금액 평균의 차이를 비교한다면, 분산분석으로는 유의미한 차이를 발견하지 못하게 된다.

### 3.8.1 F 통계량

- 분산분석에서 F 통계량은 두 개 이상의 그룹의 평균이 동일한지를 검증하는 통계 검정 방법 중 하나이다.
- F 통계량은 각 그룹의 평균을 구하고, 그룹 간 분산을 그룹 내 분산으로 나눈 값을 사용하여 계산된다.
- F 통계량 값이 임계값보다 크면 귀무가설(평균이 동일하다)을 기각하고 대립가설(평균이 서로 다르다)을 채택한다.

### 3.8.2 이원 분산분석

- A/B/C/D 검정은 변하는 요소가 하나인 일원 ANOVA이다. 근데 주말 대 평일 이라는 두번째 요소를 고려해야 할때는 이원 분산분석을 사용해야 한다.
- 

## 3.8 분산분석

- 분산분석(ANOVA: Analysis of Variance)은 여러 그룹 간의 평균 차이가 통계적으로 유의미한지를 검증하는 방법이다.
- 각 그룹 내의 변동과 그룹 간의 변동을 비교하여 평균 차이의 크기를 계산한다.
- 일원분산분석과 이원분산분석으로 나뉘며, 각각 독립변수가 1개와 2개인 경우에 사용된다.
- 분산분석 절차
    1. 귀무가설과 대립가설 설정
    2. 유의수준 설정
    3. 가설검정을 위한 검정통계량 계산
    4. 귀무가설의 기각 여부 결정
- 분산분석 예제
    - 서로 다른 브랜드의 광고에 노출된 고객들의 구매금액을 비교한다.
    - 광고 브랜드별로 그룹을 나누어 각 그룹의 구매금액 평균을 비교한다.
    - 광고 브랜드별로 그룹을 나누지 않고 모든 데이터를 하나의 그룹으로 묶고, 브랜드별로 구매금액 평균의 차이를 비교한다면, 분산분석으로는 유의미한 차이를 발견하지 못하게 된다.

### 3.8.1 F 통계량

- 분산분석에서 F 통계량은 두 개 이상의 그룹의 평균이 동일한지를 검증하는 통계 검정 방법 중 하나이다.
- F 통계량은 각 그룹의 평균을 구하고, 그룹 간 분산을 그룹 내 분산으로 나눈 값을 사용하여 계산된다.
- F 통계량 값이 임계값보다 크면 귀무가설(평균이 동일하다)을 기각하고 대립가설(평균이 서로 다르다)을 채택한다.

### 3.8.2 이원 분산분석

- 이원분산분석(two-way ANOVA)은 두 개 이상의 독립변수가 있는 경우, 각 독립변수와 종속변수 간의 상호작용 효과와 각 독립변수의 주 효과를 동시에 파악하는 분석 방법이다.
- 분산분석은 여러 그룹의 실험 겨로가를 분석하기 위한 통계적 절차이다.
- A/B 검정과 비슷한 절차를 확장하여 그룹 간 전체적인 편차가 우연히 발생할 수 있는 범위 내에 있는지를 평가하기 위해 사용한다.
- ANOVA의 결과 중 유용한 점 중 하나는 그룹 처리, 상호작용 효과, 오차와 관련된 분산의 구성 요소들을 구분하는 데 있다.

## 3.9 카이제곱검정

- 웹 테스트 시에는, 종종 단순한 A/B 검정을 넘어 동시에 여러 가지 처리를 한 번에 테스트할 필요가 있다.
- 카이제곱 검정은 횟수 관련 데이터에 주로 사용되며 예상되는 분포에 얼마나 잘 맞는지를 검정한다.

---

카이제곱통계량 : 기댓값으로부터 어떤 관찰값까지의 거리를 나타내는 측정치

기댓값 : 어떤 가정으로부터 데이터가 발생할 때, 그에 대해 기대하는 정도

d.f. : 자유도

---

### 3.9.1 카이제곱검정: 재표본추출 방법

- 피어슨 잔차 공식은 분할표에서 관측된 빈도와 기대 빈도 사이의 차이를 측정하는 데 사용된다.
- 잔차 = (관측된 빈도 - 기대 빈도) / sqrt(기대 빈도)
- 여기서 관측된 빈도는 분할표의 셀에서 실제로 나타난 빈도이며, 기대 빈도는 행과 열 변수 사이의 독립성 귀무 가설 하에서 예상되는 빈도이다.

### 3.9.2 카이제곱검정: 통계적 이론

- 적절한 표준 카이제곱분포는 자유도에 의해 결정된다.
- 카이제곱 분포는 일반적으로 한쪽으로 기울어져 있고 오른쪽으로 긴 꼬리가 있다.
- 관찰된 통계량이 카이제곱 분포의 바깥쪽에 위치할수록 p값은 낮아진다.

<img src='../gunwo/Chapter 3/Untitled 2.png'>


### 3.9.3 피셔의 정확검정

- 사건 발생 횟수가 매우 낮을 때는 예외이지만, 이런 예외적인 경우에도 재표본추출 방법을 통해 더 정확한 p값을 얻을 수 있다. 이를 피셔의 정확검정이라고 한다.
- 범주형 데이터에서 초기화분포 기반 정확한 p-value를 계산하는 방법이다.

## 3.10 멀티암드 밴딧 알고리즘

- 실험 설계에 대한 전통적인 통계적 접근 방식보다 명시적인 최적화와 좀 더 빠른 의사결정을 가능하게 하며, 여러 테스트, 특히 웹 테스트를 위해 사용된다.
- 전통적인 A/B 검정을 사용하게 되면 몇가지 어려움을 겪을 수 있다.
    - 결론을 내리기 어려울 수 있다.
    - 실험이 끝나기 전에 이미 얻을 결과들을 이용하기 시작할 수 도 있다
    - 시험이 끝난 후 부가 데이터를 기반으로 다른 것을 시도하고 싶을 수 있다.
- 밴딧 알고리즘을 사용하면 한번에 여러가지 처리를 테스트하고 기존의 통계 설계보다 빠르게 결론을 얻을 수 있다.
- 앱실론-그리디 알고리즘
    1. 0부터 1 사이의 균등분포의 난수를 생성한다
    2. 0과 앱실론 사이에 존재하면 동전 뒤집기
        1. 앞면이면 A표시
        2. 뒷면이면 B표시
    3. 숫자가 앱실론보다 크면, 지금까지 가장 좋은 결과를 보인 제안을 표시한다.
- 밴딧 알고리즘은 3가지 잉상의 처리를 효율적으로 다루고 ‘최고’를 위한 최적의 선택을 하도록 돕는다.

## 3.11 검정력과 표본크기

- 검정력이란 특정 표본 조건에서 특정한 효과크기를 알아낼 수 있는 확률을 의미한다.
- 검정력을 구하기 위해 형식적인 절차를 모두 지킬 필요는 없지만 가끔 .A/B 검정을 위해 데이터를 수집하고 처리하는데 비용이 발생하는 경우 사용해야 할 수도 있다.

### 3.11.1 표본크기

- 검정력 계산의 주된 용도는 표본크기가 어느 정도 필요한가를 추정하는 것이다.
- 효과 크기가 표본 크기를 좌우한다.
- 검정력 혹은 필요한 표본크기의 계산과 관련한 다음 4가지 중요한 요소들이 있다.
    - 표본크기
    - 탐지하고자 하는 효과크기
    - 가설검정을 위한 유의수준
    - 검정력
        - 이 중 3가지를 정하면 나머지 하나를 알 수 있다.